<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ÅŠOB Universe â€” Revenue Ripple Map (v2, dataâ€‘driven)</title>
<style>
  html, body { margin:0; height:100%; background:#000; overflow:hidden; font-family:system-ui, sans-serif; color:#fff; }
  canvas { display:block; width:100%; height:100%; background:radial-gradient(circle at center,#020202 0%,#000 100%); }
  #tooltip { position:fixed; background:rgba(20,20,30,0.95); padding:10px 14px; border-radius:8px; color:white; font-size:0.9rem; pointer-events:none; display:none; box-shadow:0 0 15px rgba(0,0,0,0.5); border:1px solid rgba(100,100,255,0.2); z-index:50; }
  #title { position:fixed; top:12px; left:16px; font-size:1rem; color:#93c5fd; letter-spacing:0.5px; }
  #panel { position:fixed; right:10px; top:10px; bottom:10px; width:360px; background:rgba(12,16,24,0.88); border:1px solid rgba(100,100,255,0.18); border-radius:12px; padding:12px; overflow:auto; }
  .h { font-size:14px; color:#c7d2fe; margin:6px 0; text-transform:uppercase; letter-spacing:.08em }
  .row { font-size:14px; margin:4px 0; display:flex; justify-content:space-between; gap:8px; }
  .muted { color:#9fb2c2; font-size:12px; }
  .chip { display:inline-block; padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); margin-left:6px; font-size:12px; }
  .causal { color:#34d399; border-color:#34d39955; }
  .incausal { color:#fbbf24; border-color:#fbbf2455; }
</style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="title">ÅŠOB Universe â€” Revenue Ripple Map (v2)</div>
  <div id="panel">
    <div class="h">August/September â€” Leaderboard</div>
    <div id="leader"></div>
    <div class="h">NOB Pattern Nodes</div>
    <div id="nodes"></div>
    <div class="h">Links</div>
    <div><span class="chip causal">Causal</span> <span class="chip incausal">Inâ€‘causal (inâ€‘obvious)</span></div>
    <div id="links"></div>
    <div class="h">Notes</div>
    <div class="muted">Causal = numeric/process drivers. Inâ€‘causal = social/emotional ripples that alter process probability.</div>
  </div>
  <div id="tooltip"></div>

<script>
const DATA_URL = '../datasets/nob_sales_causality.json';

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let w = canvas.width = window.innerWidth;
let h = canvas.height = window.innerHeight;

let nodes = [], stars = [], tooltip = document.getElementById('tooltip');
let timeline = [];

class UniverseNode {
  constructor(obj, index) {
    Object.assign(this, obj);
    this.index = index;
    this.angle = Math.random() * Math.PI * 2;
    this.radius = 100 + (obj.value / 500);
    this.speed = 0.001 + (obj.value / 2000000);
    this.x = w/2;
    this.y = h/2;
    this.pulse = Math.random() * Math.PI * 2;
  }
  update() {
    this.angle += this.speed;
    this.pulse += 0.05;
    const tx = w/2 + Math.cos(this.angle) * this.radius;
    const ty = h/2 + Math.sin(this.angle) * this.radius * 0.6;
    this.x += (tx - this.x) * 0.05;
    this.y += (ty - this.y) * 0.05;
  }
  draw() {
    const size = 10 + Math.sin(this.pulse) * 2;
    ctx.beginPath();
    ctx.fillStyle = this.color;
    ctx.shadowBlur = 20;
    ctx.shadowColor = this.color;
    ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#fff';
    ctx.font = '13px system-ui';
    ctx.fillText(this.label, this.x + 15, this.y + 5);
  }
  isHover(mx, my) { return Math.hypot(mx - this.x, my - this.y) < 15; }
}

function initStars() {
  for (let i = 0; i < 200; i++) {
    stars.push({ x: Math.random() * w, y: Math.random() * h, z: Math.random() * 1.5, twinkle: Math.random() });
  }
}
function drawStars() {
  stars.forEach(s => {
    s.x -= s.z; s.y += s.z * 0.3;
    if (s.x < 0 || s.y > h) { s.x = Math.random() * w; s.y = 0; }
    s.twinkle += 0.1;
    ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.sin(s.twinkle) * 0.3})`;
    ctx.fillRect(s.x, s.y, 1, 1);
  });
}

function initNodes() {
  nodes = timeline.map((n, i) => new UniverseNode(n, i));
}

function animate() {
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, w, h);

  drawStars();

  ctx.strokeStyle = 'rgba(100,100,255,0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  nodes.forEach(n => { ctx.moveTo(w/2, h/2); ctx.lineTo(n.x, n.y); });
  ctx.stroke();

  ctx.beginPath();
  ctx.fillStyle = 'rgba(100,100,255,0.4)';
  ctx.shadowBlur = 25;
  ctx.shadowColor = '#2563eb';
  ctx.arc(w/2, h/2, 20, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.fillStyle = '#93c5fd';
  ctx.font = '14px system-ui';
  ctx.fillText('Core Efficiency Hub', w/2 - 70, h/2 - 30);

  nodes.forEach(n => { n.update(); n.draw(); });
  requestAnimationFrame(animate);
}

let mx = 0, my = 0;
canvas.addEventListener('mousemove', e => {
  mx = e.clientX; my = e.clientY;
  let found = null;
  nodes.forEach(n => { if (n.isHover(mx, my)) found = n; });
  if (found) {
    tooltip.style.display = 'block';
    tooltip.style.left = (mx + 15) + 'px';
    tooltip.style.top = (my + 15) + 'px';
    const efficiency = ((found.value / 50000) * 100).toFixed(1);
    tooltip.innerHTML = `<b>${found.label}</b><br>ðŸ’° Revenue: Â£${found.value.toLocaleString()}<br>ðŸ‘¥ Team: ${found.team}<br>ðŸ“ˆ Efficiency: ${efficiency}% of baseline`;
  } else {
    tooltip.style.display = 'none';
  }
});

window.addEventListener('resize', () => {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
});

// ---- Right panel population ----
function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt) e.textContent=txt; return e; }

fetch(DATA_URL).then(r=>r.json()).then(j=>{
  // Leaderboard
  const L = (j.aug_sep_blocks.totals_so_far || []).slice().sort((a,b)=>b.amount-a.amount);
  const leader = document.getElementById('leader');
  L.forEach((r,i)=>{
    const row = el('div','row');
    const name = el('div',null, `${i+1}. ${r.name}`);
    const val = el('div',null, `Â£${(r.amount||0).toLocaleString()}`);
    row.appendChild(name); row.appendChild(val); leader.appendChild(row);
  });
  const total = (j.aug_sep_blocks.totals_so_far_calc||0);
  leader.appendChild(el('div','row', '')); // spacer
  const sum = el('div','row');
  sum.appendChild(el('div',null,'Total'));
  sum.appendChild(el('div',null,`Â£${total.toLocaleString()}`));
  leader.appendChild(sum);

  // Nodes
  const np = document.getElementById('nodes');
  (j.pattern_nodes||[]).forEach(n=>{
    const row = el('div','muted');
    row.innerHTML = `<b>${n.Title}</b><br><span class='muted'>Î›:${n.Lambda} Î”:${n.Delta} Î¨:${n.Psi}</span>`;
    np.appendChild(row);
  });

  // Links
  const linkBox = document.getElementById('links');
  (j.edges.causal||[]).forEach(e=>{
    const d = el('div','muted');
    d.innerHTML = `<span class='chip causal'>C</span> ${e.from} â†’ ${e.to} â€” ${e.why}`;
    linkBox.appendChild(d);
  });
  (j.edges.inCausal||[]).forEach(e=>{
    const d = el('div','muted');
    d.innerHTML = `<span class='chip incausal'>I</span> ${e.from} â†’ ${e.to} â€” ${e.why}`;
    linkBox.appendChild(d);
  });

  // Timeline nodes for the canvas
  timeline = j.timeline || [];
  initStars(); initNodes(); animate();
}).catch(console.error);
</script>
</body>
</html>
